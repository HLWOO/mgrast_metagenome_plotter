---
title: "Tutorial on generating MG-Rast metagenome plots with R"
author: "Hannah Woo (University of Tennessee)"
date: "January 15, 2016"
output: md_document
---

JL

##Short Description
This Rmarkdown tutorial utilized the Global Ocean Survey dataset that is publicly available online at MG-RAST.  We will utilize the SEED Subsystems annotation of the GOS dataset. Metadata was also available publicly from the MG-RAST site.  Both files are included in the source under the data folder.

##Reading in the data:
First, we read in the subsystems annotation of the GOS dataset from MG-RAST as a tab deliminted file.

We will plot category vs abundance. Other columns in the annotation file such as E-value and number of hits will be ignored for now.

Abundances will be converted into a proportions of total genes for each metagenome.

As a sanity check, we find that annotated genes proportions for each metagenome sums to 1 as expected.

```{r}
library(plyr) #required package

#use this function to parse just the categories and abundance data of the Global Ocean Survey data.
data_readin_mgrast<-function(filename){
data_subsystems_gos<-read.delim(
  filename, 
  header = TRUE, 
  sep = "\t", 
  quote = "", 
  dec = ".", 
  colClasses=c("factor","factor","factor","factor","factor","integer","NULL","NULL","NULL","NULL","NULL"))
  
#transform original data into proportions for plotting
data_subsystems_gos<-ddply(
  data_subsystems_gos, 
  c("metagenome"), 
  transform, 
  relative_abundance_of_all_annotated_genes = (abundance / sum(abundance)))
}

data_GOS<-data_readin_mgrast('data/table_subsystemsMGRAST_GOS.tsv')

#sanity check
tapply(data_GOS$relative_abundance_of_all_annotated_genes,data_GOS$metagenome, sum)
```
##Reading in the metadata:

Read in metadata and combine with abundance data.  This example metadata has 
```{r}
#Read in the metadata for the GOS metagenomes

metadata_readin_mgrast<-function(datamatrixname,filename2, metadata.col){
metadata_gos<-read.delim('data/metadata_MGRAST_GOS.tsv', header = TRUE, sep = "\t", quote = "",
           dec = ".")

#need to make sure these are characters for the following functions to work properly
mgrastid=as.character(metadata_gos$MG.RAST.ID)
#metadata.col<-"Location"
location=as.character(metadata_gos[[metadata.col]])

#add a new columns the abundance dataframe so that they can be identified by location 
datamatrixname$metagenome_metadatacol<-mapvalues(datamatrixname$metagenome, from =mgrastid, to = location)   
return(datamatrixname)
}

globalocean_data_metadata<-metadata_readin_mgrast(datamatrixname = data_GOS, filename2 = 'data/metadata_MGRAST_GOS.tsv', metadata.col = "Location")


#find how many pathways have information to plot
proportionlevel1_pathwaynames<-levels(unique(factor(globalocean_data_metadata$level.1))) 

```


```{r, echo=FALSE}
  require(ggplot2)
  ggplot(globalocean_data_metadata[globalocean_data_metadata$level.1==proportionlevel1_pathwaynames[1],],aes(level.2,relative_abundance_of_all_annotated_genes)) + geom_point(colour="black") + theme(axis.text.x=element_text(angle=-90, size=8, colour="black")) + coord_flip() + ggtitle(paste(proportionlevel1_pathwaynames[1],"level.1 TESTINGJL"))
```
##Define plotting functions:
Define two functions so that annotation can be plotted by the most broad category and by their environment
```{r}
#plot all the functions of each level 1 category
proportionplotting_level1 <- function(matrixname,i) {
  require(ggplot2); 
  outputplot=ggplot(matrixname[matrixname$level.1==i,],aes(level.2,relative_abundance_of_all_annotated_genes)) + geom_point(colour="black") + theme(axis.text.x=element_text(angle=-90, size=8, colour="black")) + coord_flip() + ggtitle(paste(i,"level.1")); 
  return(outputplot)
  }

proportionplotting_level1_byenvironment <- function(matrixname,environment) {
  require(ggplot2); 
  outputplot=ggplot(matrixname[which(matrixname$metagenomelocation==environment),],aes(level.1,relative_abundance_of_all_annotated_genes), fill=metagenometype) + geom_bar(stat="identity", position="dodge", aes(fill=metagenomelocation), colour="black") + theme(axis.text.x=element_text(angle=-90, size=8, colour="black"),legend.position ="top") + scale_fill_manual(values=c("#FFFFFF","#a9a9a9")) + coord_flip() + ggtitle(paste(environment,"level.1")); 
  return(outputplot)
  }
```
##Output to PDF:
Create a pdf with all the plots
```{r, eval=FALSE}
library(ggplot2)

pdf(file="bypathway.pdf", width=12) 
  lapply(X= proportionlevel1_pathwaynames, FUN= proportionplotting_level1, matrixname=data_subsystems_gos)
  dev.off()
  
pdf(file="bypathway_environment.pdf", width=12) 
  lapply(X = location, FUN = proportionplotting_level1_byenvironment, matrixname=data_subsystems_gos)

  dev.off()
```
